name: Azure VM Scheduler (Start & Stop)

on:
  schedule:
    # START VM - 07:30 WIB (00:30 UTC)
    - cron: '30 00 * * *'
    # STOP VM - 20:30 WIB (13:30 UTC)
    - cron: '30 13 * * *'
  workflow_dispatch:

env:
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  VM_NAME: ${{ secrets.AZURE_VM_NAME }}
  # Schedule times (UTC)
  START_HOUR: '00'
  START_MINUTE: '30'
  STOP_HOUR: '13'
  STOP_MINUTE: '30'

jobs:
  vm-control:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: VM Control Logic
        shell: bash
        run: |
          set -euo pipefail

          EVENT_NAME="${GITHUB_EVENT_NAME}"

          # Get VM power state
          VM_STATE=$(az vm get-instance-view \
            --resource-group "$RESOURCE_GROUP" \
            --name "$VM_NAME" \
            --query "instanceView.statuses[?starts_with(code,'PowerState/')].code" \
            -o tsv)

          echo "Current VM state: $VM_STATE"
          echo "Trigger type: $EVENT_NAME"

          # =========================
          # MANUAL RUN
          # =========================
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"

            if [ "$VM_STATE" = "PowerState/running" ]; then
              echo "VM is running → stopping VM"
              az vm stop \
                --resource-group "$RESOURCE_GROUP" \
                --name "$VM_NAME" \
                --no-wait
            else
              echo "VM is stopped → starting VM"
              az vm start \
                --resource-group "$RESOURCE_GROUP" \
                --name "$VM_NAME"
            fi

            exit 0
          fi

          # =========================
          # SCHEDULED RUN
          # =========================
          DAY_OF_WEEK=$(date -u +"%u")   # 1=Mon ... 7=Sun
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")

          echo "UTC Day: $DAY_OF_WEEK | Time: $HOUR:$MINUTE"

          # Skip weekend (Saturday=6, Sunday=7)
          if [ "$DAY_OF_WEEK" -ge 6 ]; then
            echo "Weekend detected → skipping scheduled action"
            exit 0
          fi

          # START VM - within 10 minutes of scheduled time
          if [ "$HOUR" -eq "$START_HOUR" ] && [ "$MINUTE" -ge "$START_MINUTE" ] && [ "$MINUTE" -le $((START_MINUTE + 10)) ]; then
            if [ "$VM_STATE" != "PowerState/running" ]; then
              echo "Weekday morning → starting VM"
              az vm start \
                --resource-group "$RESOURCE_GROUP" \
                --name "$VM_NAME"
            else
              echo "VM already running → no action"
            fi
          fi

          # STOP VM - within 30 minutes of scheduled time
          if [ "$HOUR" -eq "$STOP_HOUR" ] && [ "$MINUTE" -ge "$STOP_MINUTE" ] && [ "$MINUTE" -le $((STOP_MINUTE + 30)) ]; then
            if [ "$VM_STATE" = "PowerState/running" ]; then
              echo "Weekday evening → stopping VM"
              az vm stop \
                --resource-group "$RESOURCE_GROUP" \
                --name "$VM_NAME" \
                --no-wait
            else
              echo "VM already stopped → no action"
            fi
          fi