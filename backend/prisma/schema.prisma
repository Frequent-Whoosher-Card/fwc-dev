generator client {
  provider = "prisma-client"
  output   = "generated/client"
}

generator prismabox {
  provider                    = "prismabox"
  output                      = "generated/prismabox"
  inputModel                  = "true"
  typeboxImportDependencyName = "elysia"
  typeboxImportVariableName   = "t"
}

datasource db {
  provider = "postgresql"
}

// Enum

enum CardStatus {
  ON_REQUEST
  IN_OFFICE
  IN_TRANSIT
  ON_TRANSFER
  IN_STATION
  LOST
  DAMAGED
  BLOCKED
  DELETED
  SOLD_ACTIVE
  SOLD_INACTIVE
  LOST_BY_PASSANGER
}

enum TransactionStatus {
  Success
  Failed
  Pending
}

enum StockMovementType {
  IN
  OUT
  GENERATED
  TRANSFER
}

enum StockMovementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FilePurpose {
  GENERAL
  LAST_REDEEM
  BARCODE_IMAGE
  GENERATION_DOCUMENT
}

enum Gender {
  L
  P
}

enum SwapRequestStatus {
  PENDING_APPROVAL
  APPROVED
  COMPLETED
  REJECTED
}

enum PurchaseActivationStatus {
  PENDING
  ACTIVATED
  CANCELLED
}

enum RedeemType {
  SINGLE
  ROUNDTRIP
}

enum ReconciliationStatus {
  PENDING
  MATCHING
  COMPLETED
  FAILED
}

enum ProgramType {
  FWC
  VOUCHER
}

// Model

model Role {
  id          String           @id @default(uuid()) @map("role_id") @db.Uuid
  roleCode    String           @unique @map("role_code")
  roleName    String           @map("role_name")
  description String?
  isActive    Boolean          @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  createdBy   String?          @map("created_by") @db.Uuid
  updatedAt   DateTime         @default(now()) @map("updated_at")
  updatedBy   String?          @map("updated_by") @db.Uuid
  deletedAt   DateTime?        @map("deleted_at")
  deletedBy   String?          @map("deleted_by") @db.Uuid
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model User {
  id           String    @id @default(uuid()) @map("user_id") @db.Uuid
  fullName     String    @map("full_name")
  nip          String?   @unique
  username     String    @unique
  passwordHash String    @map("password_hash")
  email        String?
  phone        String?
  roleId       String    @map("role_id") @db.Uuid
  isActive     Boolean   @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")
  createdBy    String?   @map("created_by") @db.Uuid
  updatedAt    DateTime  @default(now()) @map("updated_at")
  updatedBy    String?   @map("updated_by") @db.Uuid
  deletedAt    DateTime? @map("deleted_at")
  deletedBy    String?   @map("deleted_by") @db.Uuid
  stationId    String?   @map("station_id") @db.Uuid

  // Relations
  activityLogs        ActivityLog[]
  purchases           CardPurchase[]       @relation("PurchaseOperator")
  redeems             Redeem[]
  approvedSwaps       CardSwapRequest[]    @relation("SwapApprover")
  executedSwaps       CardSwapRequest[]    @relation("SwapExecutor")
  rejectedSwaps       CardSwapRequest[]    @relation("SwapRejecter")
  requestedSwaps      CardSwapRequest[]    @relation("SwapRequester")
  cardSwapRequests    CardSwapRequest[]
  sentInboxes         Inbox[]              @relation("SentInboxes")
  receivedInboxes     Inbox[]              @relation("ReceivedInboxes")
  role                Role                 @relation(fields: [roleId], references: [id])
  station             Station?             @relation(fields: [stationId], references: [id])
  passwordResetTokens PasswordResetToken[]
  shifts              Shift[]
  cards               Card[]
  fcmToken            FcmToken[]

  @@map("users")
}

model Shift {
  id        String    @id @default(uuid()) @map("shift_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  startDate DateTime  @map("start_date")
  endDate   DateTime  @map("end_date")
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @map("updated_at")
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid

  user User @relation(fields: [userId], references: [id])

  @@map("shifts")
}

model CardCategory {
  id                 String              @id @default(uuid()) @map("category_id") @db.Uuid
  categoryCode       String              @map("category_code")
  categoryName       String              @map("category_name")
  description        String?
  createdAt          DateTime            @default(now()) @map("created_at")
  createdBy          String?             @map("created_by") @db.Uuid
  updatedAt          DateTime            @default(now()) @map("updated_at")
  updatedBy          String?             @map("updated_by") @db.Uuid
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by") @db.Uuid
  programType        ProgramType?        @map("program_type")
  maxQuantity        Int?                @map("max_quantity")
  cardInventories    CardInventory[]
  cardProducts       CardProduct[]
  cardStockMovements CardStockMovement[]
  lowStockAlerts     LowStockAlert[]

  @@unique([categoryCode, programType], name: "unique_category_code_program")
  @@map("card_categories")
}

model CardType {
  id                 String              @id @default(uuid()) @map("type_id") @db.Uuid
  typeCode           String              @map("type_code")
  typeName           String              @map("type_name")
  routeDescription   String?             @map("route_description")
  createdAt          DateTime            @default(now()) @map("created_at")
  createdBy          String?             @map("created_by") @db.Uuid
  updatedAt          DateTime            @default(now()) @map("updated_at")
  updatedBy          String?             @map("updated_by") @db.Uuid
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by") @db.Uuid
  classPrice         Decimal?            @map("class_price")
  programType        ProgramType?        @map("program_type")
  cardInventories    CardInventory[]
  cardProducts       CardProduct[]
  cardStockMovements CardStockMovement[]
  lowStockAlerts     LowStockAlert[]

  @@unique([typeCode, programType], name: "unique_type_code_program")
  @@map("card_types")
}

model Station {
  id                   String              @id @default(uuid()) @map("station_id") @db.Uuid
  stationCode          String              @unique @map("station_code")
  stationName          String              @map("station_name")
  location             String?
  createdAt            DateTime            @default(now()) @map("created_at")
  createdBy            String?             @map("created_by") @db.Uuid
  updatedAt            DateTime            @default(now()) @map("updated_at")
  updatedBy            String?             @map("updated_by") @db.Uuid
  deletedAt            DateTime?           @map("deleted_at")
  deletedBy            String?             @map("deleted_by") @db.Uuid
  cardInventories      CardInventory[]
  purchases            CardPurchase[]
  redeems              Redeem[]
  cardStockMovements   CardStockMovement[]
  receivedMovements    CardStockMovement[] @relation("ToStation")
  sourceSwaps          CardSwapRequest[]   @relation("SourceStation")
  cardSwapRequests     CardSwapRequest[]
  targetSwaps          CardSwapRequest[]   @relation("TargetStation")
  previousStationCards Card[]              @relation("CardPreviousStation")
  cards                Card[]
  inboxes              Inbox[]
  users                User[]
  lowStockAlerts       LowStockAlert[]

  @@map("stations")
}

model BulkDiscount {
  id          Int       @id @default(autoincrement()) @map("bulk_discount_id")
  discount    Decimal?
  minQuantity Int?      @map("min_quantity")
  maxQuantity Int?      @map("max_quantity")
  isActive    Boolean?  @default(true) @map("is_active")
  roleAccess  String[]  @default([]) @map("role_access")
  createdAt   DateTime? @default(now()) @map("created_at")
  createdBy   String?   @map("created_by") @db.Uuid
  updatedAt   DateTime? @default(now()) @map("updated_at")
  updatedBy   String?   @map("updated_by") @db.Uuid
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid

  cardPurchase CardPurchase[]

  @@map("bulk_discount")
}

model CardProduct {
  id             String       @id @default(uuid()) @map("card_product_id") @db.Uuid
  categoryId     String       @map("category_id") @db.Uuid
  typeId         String       @map("type_id") @db.Uuid
  totalQuota     Int          @map("total_quota")
  masaBerlaku    Int          @map("masa_berlaku")
  maxQuantity    Int?         @map("max_quantity")
  price          Decimal
  isActive       Boolean      @map("is_active")
  isDiscount     Boolean?     @default(false) @map("is_discount")
  serialTemplate String       @unique @map("serial_template")
  programType    ProgramType? @map("program_type")
  createdAt      DateTime     @default(now()) @map("created_at")
  createdBy      String?      @map("created_by") @db.Uuid
  updatedAt      DateTime     @default(now()) @map("updated_at")
  updatedBy      String?      @map("updated_by") @db.Uuid
  deletedAt      DateTime?    @map("deleted_at")
  deletedBy      String?      @map("deleted_by") @db.Uuid

  // Relation
  category         CardCategory      @relation(fields: [categoryId], references: [id])
  type             CardType          @relation(fields: [typeId], references: [id])
  cardSwapRequests CardSwapRequest[]
  swapRequests     CardSwapRequest[] @relation("ExpectedProduct")
  cards            Card[]

  @@unique([categoryId, typeId], name: "unique_category_type")
  @@index([categoryId, typeId], map: "index_category_type")
  @@map("card_products")
}

model ProductType {
  id           String       @id @default(uuid()) @map("product_type_id") @db.Uuid
  programId    String       @map("program_id") // 2 serial awal
  description  String?
  abbreviation String?
  programType  ProgramType? @map("program_type")
  createdAt    DateTime     @default(now()) @map("created_at")
  createdBy    String?      @map("created_by") @db.Uuid
  updatedAt    DateTime     @default(now()) @map("updated_at")
  updatedBy    String?      @map("updated_by") @db.Uuid
  deletedAt    DateTime?    @map("deleted_at")
  deletedBy    String?      @map("deleted_by") @db.Uuid

  @@map("product_types")
}

model EmployeeType {
  id          String    @id @default(uuid()) @map("employee_type_id") @db.Uuid
  code        String    @unique @map("code")
  name        String    @map("name")
  description String?   @map("description")
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String?   @map("created_by") @db.Uuid
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   String?   @map("updated_by") @db.Uuid
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid

  // Relations
  members Member[]

  @@map("employee_types")
}

model Member {
  id             String    @id @default(uuid()) @map("member_id") @db.Uuid
  name           String    @map("member_name")
  identityNumber String    @unique @map("identity_number")
  nationality    String?
  email          String?
  phone          String?
  nippKai        String?   @map("nipp_kai")
  birthDate      DateTime? @map("birth_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  createdBy      String?   @map("created_by") @db.Uuid
  updatedAt      DateTime  @default(now()) @map("updated_at")
  updatedBy      String?   @map("updated_by") @db.Uuid
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by") @db.Uuid
  gender         Gender?
  alamat         String?
  notes          String?
  companyName    String?   @map("company_name")
  employeeTypeId String?   @map("employee_type_id") @db.Uuid
  cityId         String?   @map("city_id") @db.Uuid

  // Relations
  employeeType EmployeeType?  @relation(fields: [employeeTypeId], references: [id])
  purchases    CardPurchase[]
  cards        Card[]
  city         City?          @relation(fields: [cityId], references: [id])

  @@map("members")
}

model FileObject {
  id             String      @id @default(uuid()) @map("file_id") @db.Uuid
  originalName   String      @map("original_name")
  storedName     String?     @map("stored_name")
  relativePath   String      @unique @map("relative_path")
  mimeType       String      @map("mime_type")
  sizeBytes      Int?        @map("size_bytes")
  checksumSha256 String?     @map("checksum_sha256")
  purpose        FilePurpose
  createdAt      DateTime    @default(now()) @map("created_at")
  createdBy      String?     @map("created_by") @db.Uuid
  updatedAt      DateTime    @default(now()) @map("updated_at")
  updatedBy      String?     @map("updated_by") @db.Uuid
  deletedAt      DateTime?   @map("deleted_at")
  deletedBy      String?     @map("deleted_by") @db.Uuid

  // Relation
  redeems       Redeem[]
  cards         Card[]
  generateFile  CardStockMovement[] @relation("generateFile")
  notaDinasFile CardStockMovement[] @relation("notaDinasFile")
  bastFile      CardStockMovement[] @relation("bastFile")

  @@map("file_object")
}

model Card {
  id                   String             @id @default(uuid()) @map("card_id") @db.Uuid
  serialNumber         String             @unique @map("serial_number")
  memberId             String?            @map("member_id") @db.Uuid
  cardProductId        String             @map("card_product_id") @db.Uuid
  quotaTicket          Int                @map("quota_ticket")
  purchaseDate         DateTime?          @map("purchase_date")
  expiredDate          DateTime?          @map("expired_date")
  status               CardStatus         @map("status_card")
  createdAt            DateTime           @default(now()) @map("created_at")
  createdBy            String?            @map("created_by") @db.Uuid
  updatedAt            DateTime           @default(now()) @map("updated_at")
  updatedBy            String?            @map("updated_by") @db.Uuid
  deletedAt            DateTime?          @map("deleted_at")
  deletedBy            String?            @map("deleted_by") @db.Uuid
  userId               String?            @map("user_id") @db.Uuid
  fileObjectId         String?            @map("file_object_id") @db.Uuid
  stationId            String?            @map("station_id") @db.Uuid
  notes                String?
  previousStationId    String?            @map("previous_station_id") @db.Uuid
  assignedSerialNumber String?
  programType          ProgramType?       @map("program_type")
  purchases            CardPurchase[]
  bulkPurchaseItems    BulkPurchaseItem[]
  redeems              Redeem[]
  cardSwapRequests     CardSwapRequest[]
  originalSwaps        CardSwapRequest[]  @relation("OriginalCard")
  replacementSwaps     CardSwapRequest[]  @relation("ReplacementCard")
  cardUsageLogs        CardUsageLog[]
  cardProduct          CardProduct        @relation(fields: [cardProductId], references: [id])
  fileObject           FileObject?        @relation(fields: [fileObjectId], references: [id])
  member               Member?            @relation(fields: [memberId], references: [id], onDelete: Restrict)
  previousStation      Station?           @relation("CardPreviousStation", fields: [previousStationId], references: [id])
  station              Station?           @relation(fields: [stationId], references: [id])
  user                 User?              @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("cards")
}

model CardInventory {
  id                  String       @id @default(uuid()) @map("inventory_id") @db.Uuid
  categoryId          String       @map("category_id") @db.Uuid
  typeId              String       @map("type_id") @db.Uuid
  stationId           String?      @map("station_id") @db.Uuid
  cardBeredar         Int          @map("card_beredar")
  cardTerjualAktif    Int          @map("card_terjual_aktif")
  cardTerjualNonAktif Int          @map("card_terjual_nonaktif")
  cardBelumTerjual    Int          @map("card_belum_terjual")
  cardOffice          Int?         @map("card_office")
  createdAt           DateTime     @default(now()) @map("created_at")
  createdBy           String?      @map("created_by") @db.Uuid
  updatedAt           DateTime     @default(now()) @map("updated_at")
  updatedBy           String?      @map("updated_by") @db.Uuid
  deletedAt           DateTime?    @map("deleted_at")
  deletedBy           String?      @map("deleted_by") @db.Uuid
  category            CardCategory @relation(fields: [categoryId], references: [id])
  station             Station?     @relation(fields: [stationId], references: [id])
  type                CardType     @relation(fields: [typeId], references: [id])

  @@unique([categoryId, typeId, stationId], name: "unique_category_type_station")
  @@index([categoryId, typeId, stationId], map: "index_category_type_station")
  @@map("card_inventory")
}

model CardStockMovement {
  id                    String              @id @default(uuid()) @map("movement_id") @db.Uuid
  movementAt            DateTime            @map("movement_at")
  movementType          StockMovementType   @map("movement_type")
  status                StockMovementStatus @map("status")
  categoryId            String              @map("category_id") @db.Uuid
  typeId                String              @map("type_id") @db.Uuid
  stationId             String?             @map("station_id") @db.Uuid
  toStationId           String?             @map("to_station_id") @db.Uuid
  batchId               String?             @map("batch_id")
  // Untuk upload dokumen setelah generate
  fileObjectId          String?             @map("file_object_id") @db.Uuid
  notaDinas             String?             @map("nota_dinas")
  notaDinasFileId       String?             @map("nota_dinas_file_id") @db.Uuid
  bast                  String?             @map("bast")
  bastFileId            String?             @map("bast_file_id") @db.Uuid
  quantity              Int                 @map("quantity")
  note                  String?             @map("note")
  createdAt             DateTime            @default(now()) @map("created_at")
  createdBy             String?             @map("created_by")
  lostSerialNumbers     String[]            @default([]) @map("lost_serial_numbers")
  damagedSerialNumbers  String[]            @default([]) @map("damaged_serial_numbers")
  receivedSerialNumbers String[]            @default([]) @map("received_serial_numbers")
  sentSerialNumbers     String[]            @default([]) @map("sent_serial_numbers")
  validatedAt           DateTime?
  validatedBy           String?
  updatedAt             DateTime            @default(now()) @map("updated_at")
  updatedBy             String?             @map("updated_by")
  deletedAt             DateTime?           @map("deleted_at")
  deletedBy             String?             @map("deleted_by")

  category      CardCategory @relation(fields: [categoryId], references: [id])
  type          CardType     @relation(fields: [typeId], references: [id])
  station       Station?     @relation(fields: [stationId], references: [id])
  toStation     Station?     @relation("ToStation", fields: [toStationId], references: [id])
  fileObject    FileObject?  @relation("generateFile", fields: [fileObjectId], references: [id])
  notaDinasFile FileObject?  @relation("notaDinasFile", fields: [notaDinasFileId], references: [id])
  bastFile      FileObject?  @relation("bastFile", fields: [bastFileId], references: [id])

  @@map("card_stock_movements")
}

model Inbox {
  id            String       @id @default(uuid()) @map("inbox_id") @db.Uuid
  title         String       @map("title")
  message       String       @map("message")
  isRead        Boolean      @default(false) @map("is_read")
  readAt        DateTime?    @map("read_at")
  sentAt        DateTime     @default(now()) @map("sent_at")
  sentTo        String?      @map("sent_to") @db.Uuid
  sentBy        String?      @map("sent_by") @db.Uuid
  stationId     String?      @map("station_id") @db.Uuid
  type          String?      @map("type")
  payload       Json?        @map("payload")
  programType   ProgramType? @map("program_type")
  readByUserIds String[]     @default([]) @map("read_by_user_ids")
  targetRoles   String[]     @default([]) @map("target_roles")
  createdAt     DateTime     @default(now()) @map("created_at")
  createdBy     String?      @map("created_by") @db.Uuid
  updatedAt     DateTime     @default(now()) @map("updated_at")
  updatedBy     String?      @map("updated_by") @db.Uuid
  deletedAt     DateTime?    @map("deleted_at")
  deletedBy     String?      @map("deleted_by") @db.Uuid
  sender        User?        @relation("SentInboxes", fields: [sentBy], references: [id])
  recipient     User?        @relation("ReceivedInboxes", fields: [sentTo], references: [id])
  station       Station?     @relation(fields: [stationId], references: [id])

  @@index([sentTo, isRead, createdAt], map: "idx_inbox_sent_to_read_created")
  @@index([sentTo, type, createdAt], map: "idx_inbox_sent_to_type_created")
  @@map("inbox")
}

model BulkPurchaseItem {
  id         String   @id @default(uuid()) @map("item_id") @db.Uuid
  purchaseId String   @map("purchase_id") @db.Uuid
  cardId     String   @map("card_id") @db.Uuid
  price      Decimal  @map("price")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @map("updated_at")

  // Relations
  purchase CardPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  card     Card         @relation(fields: [cardId], references: [id])

  @@unique([purchaseId, cardId], name: "unique_purchase_card")
  @@index([purchaseId])
  @@index([cardId])
  @@map("bulk_purchase_items")
}

model CardPurchase {
  id                 String       @id @default(uuid()) @map("purchase_id") @db.Uuid
  cardId             String?      @map("card_id") @db.Uuid
  memberId           String?      @map("member_id") @db.Uuid
  operatorId         String       @map("operator_id") @db.Uuid
  stationId          String       @map("station_id") @db.Uuid
  bulkDiscountId     Int?         @map("bulk_discount_id")
  edcReferenceNumber String       @unique @map("edc_reference_number")
  purchaseDate       DateTime     @map("purchase_date")
  price              Decimal      @map("price")
  notes              String?      @map("notes")
  programType        ProgramType? @map("program_type")
  createdAt          DateTime     @default(now()) @map("created_at")
  createdBy          String?      @map("created_by")
  updatedAt          DateTime     @default(now()) @map("updated_at")
  updatedBy          String?      @map("updated_by")
  deletedAt          DateTime?    @map("deleted_at")
  deletedBy          String?      @map("deleted_by")

  // Relation
  card              Card?              @relation(fields: [cardId], references: [id])
  member            Member?            @relation(fields: [memberId], references: [id], onDelete: Restrict)
  operator          User               @relation("PurchaseOperator", fields: [operatorId], references: [id])
  station           Station            @relation(fields: [stationId], references: [id])
  bulkDiscount      BulkDiscount?      @relation(fields: [bulkDiscountId], references: [id])
  bulkPurchaseItems BulkPurchaseItem[]
  cardSwapRequests  CardSwapRequest[]

  @@index([purchaseDate])
  @@index([stationId, purchaseDate])
  @@index([operatorId, purchaseDate])
  @@map("card_purchases")
}

model Redeem {
  id                String            @id @default(uuid()) @map("redeem_id") @db.Uuid
  cardId            String            @map("card_id") @db.Uuid
  transactionNumber String            @unique @map("transaction_number")
  operatorId        String            @map("operator_id") @db.Uuid
  stationId         String            @map("station_id") @db.Uuid
  shiftDate         DateTime          @map("shift_date")
  status            TransactionStatus @default(Success) @map("transaction_status")
  notes             String?
  createdAt         DateTime          @default(now()) @map("created_at")
  createdBy         String?           @map("created_by") @db.Uuid
  updatedAt         DateTime          @updatedAt @map("updated_at")
  updatedBy         String?           @map("updated_by") @db.Uuid
  deletedAt         DateTime?         @map("deleted_at")
  deletedBy         String?           @map("deleted_by") @db.Uuid
  fileObjectId      String?           @map("file_object_id") @db.Uuid
  redeem_type       RedeemType
  programType       ProgramType?
  card              Card              @relation(fields: [cardId], references: [id])
  fileObject        FileObject?       @relation(fields: [fileObjectId], references: [id])
  operator          User              @relation(fields: [operatorId], references: [id])
  station           Station           @relation(fields: [stationId], references: [id])
  usageLogs         CardUsageLog[]
  passengers        PassengerInfo[]

  @@map("card_redeem")
}

model PassengerInfo {
  id            String    @id @default(uuid()) @map("passenger_info_id") @db.Uuid
  passengerName String    @map("nama_passanger")
  nik           String    @map("nik")
  redeemId      String    @map("card_redeem_id") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at")
  createdBy     String?   @map("created_by") @db.Uuid
  updatedAt     DateTime  @default(now()) @map("updated_at")
  updatedBy     String?   @map("updated_by") @db.Uuid
  deletedAt     DateTime? @map("deleted_at")
  deletedBy     String?   @map("deleted_by") @db.Uuid

  redeem Redeem @relation(fields: [redeemId], references: [id])

  @@map("passenger_info")
}

model CardUsageLog {
  id             String    @id @default(uuid()) @map("log_id") @db.Uuid
  cardId         String    @map("card_id") @db.Uuid
  quotaUsed      Int       @map("quota_used")
  remainingQuota Int       @map("remaining_quota")
  usageDate      DateTime  @map("usage_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  createdBy      String?   @map("created_by")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  updatedBy      String?   @map("updated_by")
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  redeemId       String?   @map("redeem_id") @db.Uuid
  card           Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  redeem         Redeem?   @relation(fields: [redeemId], references: [id])

  @@map("card_usage_logs")
}

model CardSwapRequest {
  id                String            @id @default(uuid()) @map("swap_request_id") @db.Uuid
  purchaseId        String            @map("purchase_id") @db.Uuid
  originalCardId    String            @map("original_card_id") @db.Uuid
  replacementCardId String?           @map("replacement_card_id") @db.Uuid
  sourceStationId   String            @map("source_station_id") @db.Uuid
  targetStationId   String            @map("target_station_id") @db.Uuid
  expectedProductId String            @map("expected_product_id") @db.Uuid
  status            SwapRequestStatus @map("status")
  reason            String            @map("reason")
  notes             String?           @map("notes")
  rejectionReason   String?           @map("rejection_reason")
  requestedBy       String            @map("requested_by") @db.Uuid
  requestedAt       DateTime          @default(now()) @map("requested_at")
  approvedBy        String?           @map("approved_by") @db.Uuid
  approvedAt        DateTime?         @map("approved_at")
  executedBy        String?           @map("executed_by") @db.Uuid
  executedAt        DateTime?         @map("executed_at")
  rejectedBy        String?           @map("rejected_by") @db.Uuid
  rejectedAt        DateTime?         @map("rejected_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  userId            String?           @db.Uuid
  stationId         String?           @db.Uuid
  cardProductId     String?           @db.Uuid
  cardId            String?           @db.Uuid
  history           CardSwapHistory[]
  approver          User?             @relation("SwapApprover", fields: [approvedBy], references: [id])
  card              Card?             @relation(fields: [cardId], references: [id])
  cardProduct       CardProduct?      @relation(fields: [cardProductId], references: [id])
  executor          User?             @relation("SwapExecutor", fields: [executedBy], references: [id])
  expectedProduct   CardProduct       @relation("ExpectedProduct", fields: [expectedProductId], references: [id])
  originalCard      Card              @relation("OriginalCard", fields: [originalCardId], references: [id])
  purchase          CardPurchase      @relation(fields: [purchaseId], references: [id])
  rejecter          User?             @relation("SwapRejecter", fields: [rejectedBy], references: [id])
  replacementCard   Card?             @relation("ReplacementCard", fields: [replacementCardId], references: [id])
  requester         User              @relation("SwapRequester", fields: [requestedBy], references: [id])
  sourceStation     Station           @relation("SourceStation", fields: [sourceStationId], references: [id])
  station           Station?          @relation(fields: [stationId], references: [id])
  targetStation     Station           @relation("TargetStation", fields: [targetStationId], references: [id])
  user              User?             @relation(fields: [userId], references: [id])

  @@index([purchaseId], map: "idx_swap_purchase")
  @@index([status, targetStationId], map: "idx_swap_status_target")
  @@index([sourceStationId, status], map: "idx_swap_source_status")
  @@map("card_swap_requests")
}

model CardSwapHistory {
  id               String          @id @default(uuid()) @map("history_id") @db.Uuid
  swapRequestId    String          @map("swap_request_id") @db.Uuid
  purchaseId       String          @map("purchase_id") @db.Uuid
  beforeCardId     String          @map("before_card_id") @db.Uuid
  beforeStationId  String          @map("before_station_id") @db.Uuid
  beforeCardStatus String          @map("before_card_status")
  afterCardId      String          @map("after_card_id") @db.Uuid
  afterStationId   String          @map("after_station_id") @db.Uuid
  afterCardStatus  String          @map("after_card_status")
  inventoryChanges Json            @map("inventory_changes")
  executedBy       String          @map("executed_by") @db.Uuid
  executedAt       DateTime        @default(now()) @map("executed_at")
  swapRequest      CardSwapRequest @relation(fields: [swapRequestId], references: [id])

  @@index([swapRequestId], map: "idx_swap_history_request")
  @@index([purchaseId], map: "idx_swap_history_purchase")
  @@map("card_swap_history")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @map("token_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  used      Boolean
  createdAt DateTime  @map("created_at")
  createdBy String?   @map("created_by")
  updatedAt DateTime  @map("updated_at")
  updatedBy String?   @map("updated_by")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")
  notes     String?
  user      User      @relation(fields: [userId], references: [id])

  @@map("password_reset_tokens")
}

model ActivityLog {
  id          String    @id @default(uuid()) @map("log_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  action      String    @map("action")
  description String?   @map("description")
  createdAt   DateTime? @map("created_at")
  createdBy   String?   @map("created_by")
  updatedAt   DateTime? @map("updated_at")
  updatedBy   String?   @map("updated_by")
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by")
  user        User      @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model reconciliation_batches {
  batch_id                String                    @id @default(uuid()) @db.Uuid
  file_name               String                    @db.VarChar(255)
  total_rows              Int                       @default(0)
  matched_rows            Int                       @default(0)
  unmatched_rows          Int                       @default(0)
  status                  ReconciliationStatus      @default(PENDING)
  csv_path                String?                   @db.VarChar(500)
  created_at              DateTime                  @default(now())
  created_by              String?                   @db.Uuid
  matched_at              DateTime?
  matched_by              String?                   @db.Uuid
  temp_fwc_reconciliation temp_fwc_reconciliation[]

  @@map("reconciliation_batches")
}

model temp_fwc_reconciliation {
  record_id              String                 @id @default(uuid()) @db.Uuid
  batch_id               String                 @db.Uuid
  serial_number          String?                @db.VarChar(50)
  nik_clean              String                 @db.VarChar(50)
  ticketing_date         DateTime               @db.Date
  is_matched             Boolean                @default(false)
  matched_card_id        String?                @db.Uuid
  matched_redeem_id      String?                @db.Uuid
  created_at             DateTime               @default(now())
  reconciliation_batches reconciliation_batches @relation(fields: [batch_id], references: [batch_id], onDelete: Cascade)

  @@map("temp_fwc_reconciliation")
}

model MenuAccess {
  id          String  @id @default(uuid()) @map("menu_access_id") @db.Uuid
  label       String  @map("label") // e.g. "Stock Kartu"
  route       String? @map("route") // e.g. "/dashboard/stock" (nullable for parent menus)
  icon        String? @map("icon")
  ordering    Int     @default(0)
  parentId    String? @map("parent_id") @db.Uuid
  description String? @map("description")

  // Relations
  parent      MenuAccess?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children    MenuAccess[] @relation("MenuHierarchy")
  permissions Permission[]

  @@map("menu_access")
}

model Permission {
  id           String  @id @default(uuid()) @map("permission_id") @db.Uuid
  menuAccessId String? @map("menu_access_id") @db.Uuid // Nullable for global permissions
  actionCode   String  @unique @map("action_code") // e.g. "stock.view"
  actionName   String  @map("action_name") // e.g. "View Stock Data"

  // Relations
  menuAccess MenuAccess?      @relation(fields: [menuAccessId], references: [id])
  roles      RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid()) @map("role_permission_id") @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model FcmToken {
  id         String  @id @default(uuid()) @map("fcm_token_id") @db.Uuid
  token      String  @unique
  deviceInfo String? @map("device_info")
  userId     String? @map("user_id") @db.Uuid

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("fcm_tokens")
}

model City {
  id   String @id @default(uuid()) @map("city_id") @db.Uuid
  name String @map("name")

  // Relations
  members Member[]

  @@map("city")
}

model LowStockAlert {
  id           String   @id @default(uuid()) @map("low_stock_id") @db.Uuid
  categoryId   String   @map("category_id") @db.Uuid
  typeId       String   @map("type_id") @db.Uuid
  stationId    String?  @map("station_id") @db.Uuid // Null = Office
  currentStock Int      @map("current_stock")
  threshold    Int      @map("threshold")
  lastAlertAt  DateTime @default(now()) @map("last_alert_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  // Relations
  category CardCategory @relation(fields: [categoryId], references: [id])
  type     CardType     @relation(fields: [typeId], references: [id])
  station  Station?     @relation(fields: [stationId], references: [id])

  @@unique([categoryId, typeId, stationId]) // Unique constraint for upsert
  @@map("low_stock_alerts")
}
