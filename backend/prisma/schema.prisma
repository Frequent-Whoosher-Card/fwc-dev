generator client {
  provider = "prisma-client"
  output   = "generated/client"
}

generator prismabox {
  provider                    = "prismabox"
  output                      = "generated/prismabox"
  inputModel                  = "true"
  typeboxImportDependencyName = "elysia"
  typeboxImportVariableName   = "t"
}

datasource db {
  provider = "postgresql"
}

model Role {
  id          String    @id @default(uuid()) @map("role_id") @db.Uuid
  roleCode    String    @unique @map("role_code")
  roleName    String    @map("role_name")
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String?   @map("created_by") @db.Uuid
  updatedAt   DateTime  @default(now()) @map("updated_at")
  updatedBy   String?   @map("updated_by") @db.Uuid
  deletedAt   DateTime? @map("deleted_at")
  deletedBy   String?   @map("deleted_by") @db.Uuid
  users       User[]

  @@map("roles")
}

model User {
  id                  String               @id @default(uuid()) @map("user_id") @db.Uuid
  fullName            String               @map("full_name")
  nip                 String?              @unique
  username            String               @unique
  passwordHash        String               @map("password_hash")
  email               String?
  phone               String?
  roleId              String               @map("role_id") @db.Uuid
  isActive            Boolean              @default(true) @map("is_active")
  lastLogin           DateTime?            @map("last_login")
  createdAt           DateTime             @default(now()) @map("created_at")
  createdBy           String?              @map("created_by") @db.Uuid
  updatedAt           DateTime             @default(now()) @map("updated_at")
  updatedBy           String?              @map("updated_by") @db.Uuid
  deletedAt           DateTime?            @map("deleted_at")
  deletedBy           String?              @map("deleted_by") @db.Uuid
  stationId           String?              @map("station_id") @db.Uuid
  purchases           CardPurchase[]       @relation("PurchaseOperator")
  redeems             Redeem[]
  cards               Card[]
  sentInboxes         Inbox[]              @relation("SentInboxes")
  receivedInboxes     Inbox[]              @relation("ReceivedInboxes")
  passwordResetTokens PasswordResetToken[]
  role                Role                 @relation(fields: [roleId], references: [id])
  station             Station?             @relation(fields: [stationId], references: [id])

  @@map("users")
}

model CardCategory {
  id                 String              @id @default(uuid()) @map("category_id") @db.Uuid
  categoryCode       String              @unique @map("category_code")
  categoryName       String              @map("category_name")
  description        String?
  createdAt          DateTime            @default(now()) @map("created_at")
  createdBy          String?             @map("created_by") @db.Uuid
  updatedAt          DateTime            @default(now()) @map("updated_at")
  updatedBy          String?             @map("updated_by") @db.Uuid
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by") @db.Uuid
  cardInventories    CardInventory[]
  cardProducts       CardProduct[]
  cardStockMovements CardStockMovement[]

  @@map("card_categories")
}

model CardType {
  id                 String              @id @default(uuid()) @map("type_id") @db.Uuid
  typeCode           String              @unique @map("type_code")
  typeName           String              @map("type_name")
  routeDescription   String?             @map("route_description")
  createdAt          DateTime            @default(now()) @map("created_at")
  createdBy          String?             @map("created_by") @db.Uuid
  updatedAt          DateTime            @default(now()) @map("updated_at")
  updatedBy          String?             @map("updated_by") @db.Uuid
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by") @db.Uuid
  cardInventories    CardInventory[]
  cardProducts       CardProduct[]
  cardStockMovements CardStockMovement[]

  @@map("card_types")
}

model Station {
  id                 String              @id @default(uuid()) @map("station_id") @db.Uuid
  stationCode        String              @unique @map("station_code")
  stationName        String              @map("station_name")
  location           String?
  createdAt          DateTime            @default(now()) @map("created_at")
  createdBy          String?             @map("created_by") @db.Uuid
  updatedAt          DateTime            @default(now()) @map("updated_at")
  updatedBy          String?             @map("updated_by") @db.Uuid
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by") @db.Uuid
  cardInventories    CardInventory[]
  purchases          CardPurchase[]
  redeems            Redeem[]
  cardStockMovements CardStockMovement[]
  cards              Card[]
  inboxes            Inbox[]
  users              User[]

  @@map("stations")
}

model CardProduct {
  id             String       @id @default(uuid()) @map("card_product_id") @db.Uuid
  categoryId     String       @map("category_id") @db.Uuid
  typeId         String       @map("type_id") @db.Uuid
  totalQuota     Int          @map("total_quota")
  masaBerlaku    Int          @map("masa_berlaku")
  price          Decimal      @map("price") @db.Decimal(15, 2)
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  createdBy      String?      @map("created_by") @db.Uuid
  updatedAt      DateTime     @default(now()) @map("updated_at")
  updatedBy      String?      @map("updated_by") @db.Uuid
  deletedAt      DateTime?    @map("deleted_at")
  deletedBy      String?      @map("deleted_by") @db.Uuid
  serialTemplate String       @unique @map("serial_template")
  category       CardCategory @relation(fields: [categoryId], references: [id])
  type           CardType     @relation(fields: [typeId], references: [id])
  cards          Card[]

  @@unique([categoryId, typeId], name: "unique_category_type")
  @@index([categoryId, typeId], map: "index_category_type")
  @@map("card_products")
}

model Card {
  id                     String         @id @default(uuid()) @map("card_id") @db.Uuid
  serialNumber           String         @unique @map("serial_number")
  memberId               String?        @map("member_id") @db.Uuid
  cardProductId          String         @map("card_product_id") @db.Uuid
  quotaTicket            Int            @default(0) @map("quota_ticket")
  purchaseDate           DateTime?      @map("purchase_date")
  expiredDate            DateTime?      @map("expired_date")
  status                 CardStatus     @default(IN_OFFICE) @map("status_card")
  createdAt              DateTime       @default(now()) @map("created_at")
  createdBy              String?        @map("created_by") @db.Uuid
  updatedAt              DateTime       @default(now()) @map("updated_at")
  updatedBy              String?        @map("updated_by") @db.Uuid
  deletedAt              DateTime?      @map("deleted_at")
  deletedBy              String?        @map("deleted_by") @db.Uuid
  userId                 String?        @map("user_id") @db.Uuid
  fileObjectId           String?        @map("file_object_id") @db.Uuid
  stationId              String?        @map("station_id") @db.Uuid
  notes                  String?
  assigned_serial_number String?
  purchases              CardPurchase[]
  redeems                Redeem[]
  cardUsageLogs          CardUsageLog[]
  cardProduct            CardProduct    @relation(fields: [cardProductId], references: [id])
  fileObject             FileObject?    @relation(fields: [fileObjectId], references: [id])
  member                 Member?        @relation(fields: [memberId], references: [id], onDelete: Restrict)
  station                Station?       @relation(fields: [stationId], references: [id])
  user                   User?          @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([cardProductId, serialNumber])
  @@map("cards")
}

model CardInventory {
  id               String       @id @default(uuid()) @map("inventory_id") @db.Uuid
  categoryId       String       @map("category_id") @db.Uuid
  typeId           String       @map("type_id") @db.Uuid
  stationId        String?      @map("station_id") @db.Uuid
  cardBeredar      Int          @default(0) @map("card_beredar")
  cardAktif        Int          @default(0) @map("card_terjual_aktif")
  cardNonAktif     Int          @default(0) @map("card_terjual_nonaktif")
  cardBelumTerjual Int          @default(0) @map("card_belum_terjual")
  cardOffice       Int?         @default(0) @map("card_office")
  createdAt        DateTime     @default(now()) @map("created_at")
  createdBy        String?      @map("created_by") @db.Uuid
  updatedAt        DateTime     @default(now()) @map("updated_at")
  updatedBy        String?      @map("updated_by") @db.Uuid
  deletedAt        DateTime?    @map("deleted_at")
  deletedBy        String?      @map("deleted_by") @db.Uuid
  category         CardCategory @relation(fields: [categoryId], references: [id])
  station          Station?     @relation(fields: [stationId], references: [id])
  type             CardType     @relation(fields: [typeId], references: [id])

  @@unique([categoryId, typeId, stationId], name: "unique_category_type_station")
  @@index([categoryId, typeId, stationId], map: "index_category_type_station")
  @@map("card_inventory")
}

model CardStockMovement {
  id                    String              @id @default(uuid()) @map("movement_id") @db.Uuid
  movementAt            DateTime            @map("movement_at")
  type                  StockMovementType   @map("movement_type")
  status                StockMovementStatus @default(APPROVED) @map("status")
  categoryId            String              @map("category_id") @db.Uuid
  typeId                String              @map("type_id") @db.Uuid
  stationId             String?             @map("station_id") @db.Uuid
  quantity              Int                 @map("quantity")
  note                  String?             @map("note")
  createdAt             DateTime            @default(now()) @map("created_at")
  createdBy             String?             @map("created_by") @db.Uuid
  lostSerialNumbers     String[]            @default([]) @map("lost_serial_numbers")
  receivedSerialNumbers String[]            @default([]) @map("received_serial_numbers")
  sentSerialNumbers     String[]            @default([]) @map("sent_serial_numbers")
  validatedAt           DateTime?
  validatedBy           String?             @db.Uuid
  updatedAt             DateTime            @default(now()) @map("updated_at")
  updatedBy             String?             @map("updated_by") @db.Uuid
  deletedAt             DateTime?           @map("deleted_at")
  deletedBy             String?             @map("deleted_by") @db.Uuid
  damagedSerialNumbers  String[]            @default([]) @map("damaged_serial_numbers")
  batchId               String?             @map("batch_id")
  category              CardCategory        @relation(fields: [categoryId], references: [id])
  station               Station?            @relation(fields: [stationId], references: [id])
  cardType              CardType            @relation(fields: [typeId], references: [id])

  @@index([type, status, movementAt])
  @@map("card_stock_movements")
}

model Inbox {
  id        String    @id @default(uuid()) @map("inbox_id") @db.Uuid
  title     String    @map("title")
  message   String    @map("message")
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  sentAt    DateTime  @default(now()) @map("sent_at")
  sentTo    String?   @map("sent_to") @db.Uuid
  sentBy    String?   @map("sent_by") @db.Uuid
  stationId String?   @map("station_id") @db.Uuid
  type      String?   @map("type")
  payload   Json?     @map("payload")
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @map("updated_at")
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  sender    User?     @relation("SentInboxes", fields: [sentBy], references: [id])
  recipient User?     @relation("ReceivedInboxes", fields: [sentTo], references: [id])
  station   Station?  @relation(fields: [stationId], references: [id])

  @@index([sentTo, isRead, createdAt], map: "idx_inbox_sent_to_read_created")
  @@index([sentTo, type, createdAt], map: "idx_inbox_sent_to_type_created")
  @@map("inbox")
}

model Member {
  id             String         @id @default(uuid()) @map("member_id") @db.Uuid
  name           String         @map("member_name")
  identityNumber String         @unique @map("identity_number")
  nationality    String         @default("INDONESIA")
  email          String?
  phone          String?
  nippKai        String?        @map("nipp_kai")
  createdAt      DateTime       @default(now()) @map("created_at")
  createdBy      String?        @map("created_by") @db.Uuid
  updatedAt      DateTime       @default(now()) @map("updated_at")
  updatedBy      String?        @map("updated_by") @db.Uuid
  deletedAt      DateTime?      @map("deleted_at")
  deletedBy      String?        @map("deleted_by") @db.Uuid
  gender         Gender?
  alamat         String?
  notes          String?
  purchases      CardPurchase[]
  cards          Card[]

  @@map("members")
}

model Redeem {
  id                String            @id @default(uuid()) @map("redeem_id") @db.Uuid
  cardId            String            @map("card_id") @db.Uuid
  transactionNumber String            @unique @map("transaction_number")
  operatorId        String            @map("operator_id") @db.Uuid
  stationId         String            @map("station_id") @db.Uuid
  shiftDate         DateTime          @map("shift_date")
  status            TransactionStatus @default(Success) @map("transaction_status")
  notes             String?
  createdAt         DateTime          @default(now()) @map("created_at")
  createdBy         String?           @map("created_by") @db.Uuid
  updatedAt         DateTime          @default(now()) @map("updated_at")
  updatedBy         String?           @map("updated_by") @db.Uuid
  deletedAt         DateTime?         @map("deleted_at")
  deletedBy         String?           @map("deleted_by") @db.Uuid
  fileObjectId      String?           @map("file_object_id") @db.Uuid
  prev_quota        Int
  quota_used        Int
  redeem_type       RedeemType
  remain_quota      Int
  card              Card              @relation(fields: [cardId], references: [id])
  fileObject        FileObject?       @relation(fields: [fileObjectId], references: [id])
  operator          User              @relation(fields: [operatorId], references: [id])
  station           Station           @relation(fields: [stationId], references: [id])

  @@index([transactionNumber], map: "idx_redeem_transaction_number")
  @@map("card_redeem")
}

model CardPurchase {
  id                          String                   @id @default(uuid()) @map("purchase_id") @db.Uuid
  cardId                      String                   @map("card_id") @db.Uuid
  memberId                    String?                  @map("member_id") @db.Uuid
  operatorId                  String                   @map("operator_id") @db.Uuid
  stationId                   String                   @map("station_id") @db.Uuid
  edcReferenceNumber          String                   @unique @map("edc_reference_number")
  purchaseDate                DateTime                 @map("purchase_date")
  price                       Decimal                  @map("price") @db.Decimal(15, 2)
  notes                       String?
  createdAt                   DateTime                 @default(now()) @map("created_at")
  createdBy                   String?                  @map("created_by") @db.Uuid
  updatedAt                   DateTime                 @default(now()) @map("updated_at")
  updatedBy                   String?                  @map("updated_by") @db.Uuid
  deletedAt                   DateTime?                @map("deleted_at")
  deletedBy                   String?                  @map("deleted_by") @db.Uuid
  activated_at                DateTime?
  activated_by                String?                  @db.Uuid
  activation_status           PurchaseActivationStatus @default(PENDING)
  physical_card_serial_number String?
  card                        Card                     @relation(fields: [cardId], references: [id])
  member                      Member?                  @relation(fields: [memberId], references: [id], onDelete: Restrict)
  operator                    User                     @relation("PurchaseOperator", fields: [operatorId], references: [id])
  station                     Station                  @relation(fields: [stationId], references: [id])

  @@index([purchaseDate])
  @@index([stationId, purchaseDate])
  @@index([operatorId, purchaseDate])
  @@map("card_purchases")
}

model CardUsageLog {
  id             String    @id @default(uuid()) @map("log_id") @db.Uuid
  cardId         String    @map("card_id") @db.Uuid
  quotaUsed      Int       @default(0) @map("quota_used")
  remainingQuota Int       @map("remaining_quota")
  usageDate      DateTime  @map("usage_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  createdBy      String?   @map("created_by") @db.Uuid
  updatedAt      DateTime  @default(now()) @map("updated_at")
  updatedBy      String?   @map("updated_by") @db.Uuid
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by") @db.Uuid
  card           Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("card_usage_logs")
}

model FileObject {
  id             String      @id @default(uuid()) @map("file_id") @db.Uuid
  originalName   String      @map("original_name")
  storedName     String?     @map("stored_name")
  relativePath   String      @unique @map("relative_path")
  mimeType       String      @map("mime_type")
  sizeBytes      Int?        @map("size_bytes")
  checksumSha256 String?     @map("checksum_sha256")
  purpose        FilePurpose @default(GENERAL) @map("purpose")
  createdAt      DateTime    @default(now()) @map("created_at")
  createdBy      String?     @map("created_by") @db.Uuid
  updatedAt      DateTime    @default(now()) @map("updated_at")
  updatedBy      String?     @map("updated_by") @db.Uuid
  deletedAt      DateTime?   @map("deleted_at")
  deletedBy      String?     @map("deleted_by") @db.Uuid
  redeems        Redeem[]
  cards          Card[]

  @@map("file_object")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @map("token_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  used      Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @map("updated_at")
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by") @db.Uuid
  notes     String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

enum CardStatus {
  ON_REQUEST
  IN_OFFICE
  IN_TRANSIT
  IN_STATION
  LOST
  DAMAGED
  SOLD_ACTIVE
  SOLD_INACTIVE
  ASSIGNED
}

enum TransactionStatus {
  Success
  Failed
  Pending
}

enum StockMovementType {
  IN
  OUT
  GENERATED
}

enum StockMovementStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FilePurpose {
  GENERAL
  LAST_REDEEM
  BARCODE_IMAGE
}

enum Gender {
  L
    P
}

enum PurchaseActivationStatus {
  PENDING
  ACTIVATED
  CANCELLED
}

enum RedeemType {
  SINGLE
  ROUNDTRIP
}

model ReconciliationBatch {
  id            String                   @id @default(uuid()) @map("batch_id") @db.Uuid
  fileName      String                   @map("file_name")
  totalRows     Int                      @default(0) @map("total_rows")
  matchedRows   Int                      @default(0) @map("matched_rows")
  unmatchedRows Int                      @default(0) @map("unmatched_rows")
  status        ReconciliationStatus     @default(PENDING) @map("status")
  csvPath       String?                  @map("csv_path")
  createdAt     DateTime                 @default(now()) @map("created_at")
  createdBy     String?                  @map("created_by") @db.Uuid
  matchedAt     DateTime?                @map("matched_at")
  matchedBy     String?                  @map("matched_by") @db.Uuid
  records       TempFwcReconciliation[]

  @@map("reconciliation_batches")
}

model TempFwcReconciliation {
  id              String               @id @default(uuid()) @map("record_id") @db.Uuid
  batchId         String               @map("batch_id") @db.Uuid
  serialNumber    String?              @map("serial_number")
  nikClean        String               @map("nik_clean")
  ticketingDate   DateTime             @map("ticketing_date") @db.Date
  isMatched       Boolean              @default(false) @map("is_matched")
  matchedCardId   String?              @map("matched_card_id") @db.Uuid
  matchedRedeemId String?              @map("matched_redeem_id") @db.Uuid
  createdAt       DateTime             @default(now()) @map("created_at")
  batch           ReconciliationBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([serialNumber])
  @@index([nikClean, ticketingDate])
  @@index([isMatched])
  @@map("temp_fwc_reconciliation")
}

enum ReconciliationStatus {
  PENDING
  MATCHING
  COMPLETED
  FAILED
}
